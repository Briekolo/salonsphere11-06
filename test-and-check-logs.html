<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <title>Test Registration and Check Logs</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: system-ui; padding: 20px; max-width: 800px; margin: 0 auto; }
        button { background: #02011F; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; margin: 5px; }
        .log { background: #f5f5f5; padding: 10px; border-radius: 4px; margin: 10px 0; font-family: monospace; white-space: pre-wrap; }
        .error { color: red; }
        .success { color: green; }
    </style>
</head>
<body>
    <h1>Registration Test with Immediate Log Check</h1>
    
    <button onclick="testRegistration()">Test Registration</button>
    
    <div id="result"></div>
    
    <script>
        const SUPABASE_URL = 'https://drwxswnfwctstgdorhdw.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRyd3hzd25md2N0c3RnZG9yaGR3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDk2MzgyNjQsImV4cCI6MjA2NTIxNDI2NH0.ddNw5Ezz9ZuQe-abTU6gUqWOxqU6EbTltlh7JonS9aY';
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        async function testRegistration() {
            const resultDiv = document.getElementById('result');
            const email = `test-${Date.now()}@example.com`;
            const password = 'TestPassword123!';
            
            resultDiv.innerHTML = '<div class="log">Testing registration with: ' + email + '</div>';
            
            try {
                // First, let's check what happens when we call the auth endpoint directly
                const response = await fetch(`${SUPABASE_URL}/auth/v1/signup`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'apikey': SUPABASE_ANON_KEY
                    },
                    body: JSON.stringify({
                        email: email,
                        password: password,
                        data: {
                            role: 'admin',
                            pending_tenant_name: 'Debug Salon',
                            first_name: 'Debug',
                            last_name: 'Test'
                        }
                    })
                });
                
                const responseText = await response.text();
                let data;
                try {
                    data = JSON.parse(responseText);
                } catch {
                    data = { raw: responseText };
                }
                
                resultDiv.innerHTML += '<div class="log">Raw Response Status: ' + response.status + '</div>';
                resultDiv.innerHTML += '<div class="log">Raw Response: ' + JSON.stringify(data, null, 2) + '</div>';
                
                if (!response.ok) {
                    resultDiv.innerHTML += '<div class="log error">Registration failed with status ' + response.status + '</div>';
                    
                    // Now let's check if it's calling set_claim
                    if (data.msg && data.msg.includes('app_metadata')) {
                        resultDiv.innerHTML += '<div class="log error">ERROR: Still referencing app_metadata!</div>';
                        resultDiv.innerHTML += '<div class="log">This suggests GoTrue might be calling a function that uses app_metadata</div>';
                    }
                } else {
                    resultDiv.innerHTML += '<div class="log success">Registration successful!</div>';
                }
            } catch (err) {
                resultDiv.innerHTML += '<div class="log error">Error: ' + err.message + '</div>';
            }
        }
    </script>
</body>
</html>